pipeline {
    agent { label 'linux-master' }

    stages {
        stage('Run Tests') {
            steps {
                script {
                    def testResults = []

                    for (int i = 1; i <= 10; i++) {
                        // Replace the following command with your test command
                        def result = sh(script: "python --version", returnStatus: true)
                        
                        // Store the result in the list
                        testResults.add(result ? 'success' : 'failure')
                    }

                    println(testResults)

                    // Generate the report
                    def totalCycles = 10
                    def failCycles = testResults.count { it == 'failure' }
                    def passRate = (totalCycles - failCycles) * 100 / totalCycles

                    // Generate the HTML body for the email
                    def emailBody = """
                        <table>
                          <caption>Pass Rate Overview</caption>
                          <thead>
                            <tr>
                              <th></th>
                              <th scope="col">PT Stability</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <th scope="row">Test Cycles</th>
                              <td>${totalCycles}</td>
                            </tr>
                            <tr>
                              <th scope="row">Fail Cycles</th>
                              <td>${failCycles}</td>
                            </tr>
                            <tr>
                              <th scope="row">Pass Rate</th>
                              <td>${passRate}%</td>
                            </tr>
                          </tbody>
                        </table>
                        <table>
                          <caption>PT Stability</caption>
                          <thead>
                            <tr>
                              <th></th>
                              <th scope="col">Cycle1</th>
                              <th scope="col">Cycle2</th>
                              <th scope="col">Cycle3</th>
                              <th scope="col">Cycle4</th>
                              <th scope="col">Cycle5</th>
                              <th scope="col">Cycle6</th>
                              <th scope="col">Cycle7</th>
                              <th scope="col">Cycle8</th>
                              <th scope="col">Cycle9</th>
                              <th scope="col">Cycle10</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                                <th scope="row">Test Cycles</th>
                                ${testResults.empty ? '' : (0..9).collect { index -> "<td>${testResults[index] == 'success' ? 'ðŸ”µ' : 'ðŸ”´'}</td>" }.join()}
                            </tr>
                          </tbody>
                        </table>
                    """

                    // Send the email
                    emailext body: emailBody,
                        mimeType: 'text/html',
                        from: 'mayta51654944@gmail.com',
                        subject: 'Test Results',
                        to: 'mayta51654944@gmail.com'
                }
            }
        }
    }
}
